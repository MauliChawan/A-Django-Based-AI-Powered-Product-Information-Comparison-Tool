<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Comparsy</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>

    <style>
        ::-webkit-scrollbar{
            width: 6px;
        }
        ::-webkit-scrollbar-thumb{
            background: #87CEFA;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

<!-- SIDEBAR -->
<div class="fixed left-0 top-0 h-screen w-64 border-r border-gray-300 px-4 py-6 bg-white">
    <h1 class="font-bold text-xl mb-6 text-blue-600">Comparsy</h1>
    <div class="space-y-2 overflow-y-auto h-[80vh]">
        <div id="newChatBtn" class="cursor-pointer hover:bg-gray-200 p-2 rounded bg-blue-50">New Chat</div>
        <div id="historyList" class="mt-4 space-y-2">
            <!-- History items will be injected here by JS (loaded from DB) -->
            <div class="text-sm text-gray-500 px-2">Loading history...</div>
        </div>
    </div>
</div>

<!-- NAVBAR -->
<div class="fixed left-64 top-0 right-0 h-14 border-b border-gray-300 flex items-center justify-between px-6 bg-white">
    <div class="font-medium text-lg">Comparsy AI Product Comparison</div>

    <div class="flex items-center gap-5">
        {% if request.user.is_authenticated %}
            <form method="post" action="/logout/">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1 border border-red-500 text-red-600 rounded hover:bg-red-50">Logout</button>
            </form>
        {% else %}
            <a href="/login/" class="px-3 py-1 border border-blue-500 text-blue-600 rounded hover:bg-blue-50">Login</a>
            <a href="/signup/" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Signup</a>
        {% endif %}

        <div class="relative">
            <i id="userBtn" class="fa-regular fa-user text-xl cursor-pointer hover:text-blue-600"></i>

            <div id="userDropdown" class="absolute right-0 mt-2 w-40 bg-white shadow border rounded hidden">
                <div class="px-3 py-2 border-b font-semibold">{{ request.user.username|default:"Guest" }}</div>
                <a class="block px-3 py-2 hover:bg-gray-100 cursor-pointer">Help</a>
                <a class="block px-3 py-2 hover:bg-gray-100 cursor-pointer">About Comparsy</a>
            </div>
        </div>

        <i class="fa-solid fa-share-nodes text-xl cursor-pointer hover:text-blue-600"></i>
    </div>
</div>


<!-- CONTENT BLOCK -->
{% block content %}

<!-- MAIN BODY: centre area only 3 slots and controls -->
<div class="ml-64 mt-20 px-6">

    <!-- Controls: Save / Export etc. -->
    <div class="flex items-center justify-end gap-3 mb-4">
        <button id="saveComparisonBtn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Save Comparison</button>
        <button id="exportBtn" class="px-3 py-1 border rounded">Export</button>
    </div>

    <!-- 3 SLOTS - full visible cards (taller) -->
    <div class="flex justify-center mt-2 gap-6" id="productSlotsContainer">
        <div class="product-slot flex-1 max-w-[32%]">
            <div class="plusBtn slot-card w-full h-64 border border-blue-400 rounded-xl flex items-center justify-center hover:bg-blue-50 cursor-pointer transition hover:scale-105"
                 data-slot-index="0" style="flex: 0 0 32%; max-width: 32%;">
                <span class="text-8xl font-light text-blue-600">+</span>
            </div>
        </div>

        <div class="product-slot flex-1 max-w-[32%]">
            <div class="plusBtn slot-card w-full h-64 border border-blue-400 rounded-xl flex items-center justify-center hover:bg-blue-50 cursor-pointer transition hover:scale-105"
                 data-slot-index="1" style="flex: 0 0 32%; max-width: 32%;">
                <span class="text-8xl font-light text-blue-600">+</span>
            </div>
        </div>

        <div class="product-slot flex-1 max-w-[32%]">
            <div class="plusBtn slot-card w-full h-64 border border-blue-400 rounded-xl flex items-center justify-center hover:bg-blue-50 cursor-pointer transition hover:scale-105"
                 data-slot-index="2" style="flex: 0 0 32%; max-width: 32%;">
                <span class="text-8xl font-light text-blue-600">+</span>
            </div>
        </div>
    </div>

    <!-- optional area for expanded product specs (empty for now) -->
    <div id="detailArea" class="mt-6"></div>

</div>

{% endblock %}


<!-- PRODUCT SEARCH MODAL -->
<div id="searchModal" class="fixed inset-0 bg-black/40 flex justify-center items-center hidden z-50">
    <div class="bg-white w-96 rounded-xl p-5">
        <h2 class="text-lg font-semibold mb-3">Search product</h2>
        <input id="searchInput" type="text" class="w-full border p-2 rounded mb-2" placeholder="Type product...">
        <div id="suggestions" class="max-h-56 overflow-y-auto mt-2 space-y-1"></div>

        <div class="mt-4 flex gap-3">
            <button id="selectBtn" class="flex-1 w-full bg-blue-600 text-white py-2 rounded">Select</button>
            <button id="closeBtn" class="flex-1 w-full border py-2 rounded">Cancel</button>
        </div>

        <p id="closeModalText" class="mt-3 text-center text-sm text-gray-500 cursor-pointer">Close</p>
    </div>
</div>


<script>
/* -------------------------
   Config
   ------------------------- */
const PRODUCTS_API = "http://127.0.0.1:8000/api/all-products/";
const HISTORY_LIST_API = "/api/comparisons/";           // GET list of comparisons for current user
const SAVE_COMPARISON_API = "/api/comparisons/";        // POST to save a new comparison (same endpoint)
const LOAD_COMPARISON_API = "/api/comparisons/";        // GET /api/comparisons/<id>/ to load

/* -------------------------
   UI Elements
   ------------------------- */
const searchModal = document.getElementById("searchModal");
const searchInput = document.getElementById("searchInput");
const suggestionsBox = document.getElementById("suggestions");
const closeBtn = document.getElementById("closeBtn");
const closeModalText = document.getElementById("closeModalText");
const selectBtn = document.getElementById("selectBtn");
const plusBtns = document.querySelectorAll(".plusBtn");
const newChatBtn = document.getElementById("newChatBtn");
const historyListEl = document.getElementById("historyList");
const saveComparisonBtn = document.getElementById("saveComparisonBtn");
const exportBtn = document.getElementById("exportBtn");

let productsCache = [];      // store fetched products
let selectedSuggestion = null;
let currentSlotIndex = 0;

/* -------------------------
   Helpers
   ------------------------- */
function debounce(fn, delay=300){
    let t;
    return (...args)=> {
        clearTimeout(t);
        t = setTimeout(()=> fn.apply(this, args), delay);
    }
}

function formatPrice(p){
    try { return "â‚¹" + Number(p).toLocaleString('en-IN'); }
    catch(e){ return p; }
}

function getCookie(name) {
    // standard function to read CSRF cookie
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

/* -------------------------
   Modal open flow
   ------------------------- */
plusBtns.forEach(btn => {
    btn.addEventListener("click", (ev)=> {
        const idx = parseInt(btn.getAttribute("data-slot-index"));
        currentSlotIndex = idx;
        openSearchModal();
    })
})

function openSearchModal(){
    searchModal.classList.remove("hidden");
    searchInput.value = "";
    suggestionsBox.innerHTML = "";
    selectedSuggestion = null;
    // fetch products once (cache)
    if(productsCache.length === 0){
        fetch(PRODUCTS_API).then(r=>r.json()).then(data=>{
            productsCache = data;
        }).catch(e=>{
            console.error("Failed to load products", e);
            suggestionsBox.innerHTML = '<div class="p-2 text-sm text-red-500">Failed to load products</div>';
        });
    }
    setTimeout(()=> searchInput.focus(), 150);
}

/* -------------------------
   Search & suggestions (client-side filtering)
   ------------------------- */
const onType = debounce(()=> {
    const q = searchInput.value.trim().toLowerCase();
    suggestionsBox.innerHTML = "";
    selectedSuggestion = null;
    if(!q) return;
    const matches = productsCache.filter(p => {
        if(!p) return false;
        const name = (p.name || "").toString().toLowerCase();
        const brand = (p.brand || "").toString().toLowerCase();
        return name.includes(q) || brand.includes(q);
    }).slice(0, 15);

    if(matches.length === 0){
        suggestionsBox.innerHTML = `<div class="p-2 text-sm text-gray-500">No results</div>`;
        return;
    }

    matches.forEach(item => {
        const node = document.createElement("div");
        node.className = "p-2 hover:bg-gray-100 cursor-pointer rounded flex justify-between items-center";
        node.innerHTML = `<div>
                                <div class="font-semibold">${item.brand || ""}</div>
                                <div class="text-sm text-gray-600">${item.name || ""}</div>
                           </div>
                           <div class="text-sm text-gray-700">${formatPrice(item.price)}</div>`;
        node.addEventListener("click", ()=> {
            // highlight selection visually
            [...suggestionsBox.children].forEach(ch => ch.classList.remove("bg-blue-50", "border-blue-300"));
            node.classList.add("bg-blue-50", "border", "border-blue-300");
            selectedSuggestion = item;
        });
        suggestionsBox.appendChild(node);
    });
}, 200);

searchInput.addEventListener("input", onType);

/* -------------------------
   Select / Close Modal
   ------------------------- */
selectBtn.addEventListener("click", ()=> {
    if(!selectedSuggestion){
        const q = searchInput.value.trim().toLowerCase();
        if(q){
            const fallback = productsCache.find(p => (p.name||"").toLowerCase() === q || (p.brand||"").toLowerCase() === q);
            if(fallback) selectedSuggestion = fallback;
        }
    }
    if(selectedSuggestion) {
        fillSlotWithProduct(currentSlotIndex, selectedSuggestion);
        closeSearchModal();
    } else {
        selectBtn.classList.add("animate-pulse");
        setTimeout(()=> selectBtn.classList.remove("animate-pulse"), 400);
    }
});

function closeSearchModal(){
    searchModal.classList.add("hidden");
    searchInput.value = "";
    suggestionsBox.innerHTML = "";
    selectedSuggestion = null;
}

closeBtn.addEventListener("click", closeSearchModal);
closeModalText.addEventListener("click", closeSearchModal);

/* -------------------------
   Fill slot with product card
   ------------------------- */
function buildProductCardHTML(product){
    const brand = product.brand || "";
    const name = product.name || "";
    const price = (product.price !== null && product.price !== undefined) ? formatPrice(product.price) : "";
    return `
        <div class="w-full h-64 border border-gray-200 rounded-xl p-4 flex flex-col justify-between bg-white">
            <div>
                <div class="text-xs text-gray-500">${brand}</div>
                <div class="font-semibold text-lg">${name}</div>
            </div>
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-700 font-medium">${price}</div>
                <div class="flex gap-2">
                    <button class="remove-btn px-3 py-1 text-sm border rounded">Remove</button>
                    <button class="details-btn px-3 py-1 text-sm border rounded">Details</button>
                </div>
            </div>
        </div>
    `;
}

function fillSlotWithProduct(slotIndex, product){
    const allSlots = document.querySelectorAll(".plusBtn");
    let target = null;
    if(typeof slotIndex === "number"){
        target = allSlots[slotIndex];
    }
    if(!target || target.innerText.trim() !== '+'){
        target = Array.from(allSlots).find(el => el.innerText.trim() === '+');
    }
    if(!target){
        target = allSlots[0];
    }

    target.innerHTML = buildProductCardHTML(product);

    // attach remove & details button handler
    const removeBtn = target.querySelector(".remove-btn");
    removeBtn && removeBtn.addEventListener("click", ()=> {
        resetSlotToPlus(target);
    });
    const detailsBtn = target.querySelector(".details-btn");
    detailsBtn && detailsBtn.addEventListener("click", ()=> {
        showDetails(product);
    });
}

/* -------------------------
   Reset slot to plus
   ------------------------- */
function resetSlotToPlus(targetElement){
    targetElement.innerHTML = `<span class="text-8xl font-light text-blue-600">+</span>`;
}

/* -------------------------
   New Chat behaviour (clear UI)
   ------------------------- */
newChatBtn.addEventListener("click", ()=> {
    document.querySelectorAll(".plusBtn").forEach(el => resetSlotToPlus(el));
    // clear details area
    document.getElementById('detailArea').innerHTML = '';
    closeSearchModal();
});

/* -------------------------
   Utility: allow tapping on a filled slot to reopen modal & replace
   ------------------------- */
document.addEventListener("click", (e) => {
    const el = e.target.closest(".plusBtn");
    if(el){
        const idx = parseInt(el.getAttribute("data-slot-index"));
        currentSlotIndex = isNaN(idx) ? 0 : idx;
        openSearchModal();
    }
});

/* -------------------------
   Small UX: toggle user dropdown
   ------------------------- */
const userBtn = document.getElementById("userBtn");
const userDropdown = document.getElementById("userDropdown");
userBtn.onclick = () => userDropdown.classList.toggle("hidden");

/* -------------------------
   Save / Load history (DB) helpers
   ------------------------- */

async function loadHistoryList(){
    // fetch user's comparisons from backend
    try{
        const res = await fetch(HISTORY_LIST_API);
        if(!res.ok) throw new Error('Failed');
        const list = await res.json();
        renderHistoryList(list);
    }catch(e){
        historyListEl.innerHTML = `<div class="text-sm text-gray-500 px-2">Could not load history</div>`;
        console.error(e);
    }
}

function renderHistoryList(list){
    if(!Array.isArray(list) || list.length === 0){
        historyListEl.innerHTML = `<div class="text-sm text-gray-500 px-2">No history yet</div>`;
        return;
    }
    historyListEl.innerHTML = '';
    list.forEach(item => {
        // item expected: {id, name, created_at, product_ids}
        const node = document.createElement('div');
        node.className = 'cursor-pointer hover:bg-gray-100 p-2 rounded flex justify-between items-center';
        node.innerHTML = `<div>
                            <div class="font-medium">${item.name || ('Comparison #' + item.id)}</div>
                            <div class="text-xs text-gray-500">${new Date(item.created_at).toLocaleString()}</div>
                          </div>
                          <div class="text-sm text-gray-600">${(item.product_ids||[]).length} items</div>`;
        node.addEventListener('click', ()=> loadComparison(item.id));
        historyListEl.appendChild(node);
    });
}

async function loadComparison(id){
    try{
        const res = await fetch(LOAD_COMPARISON_API + id + '/');
        if(!res.ok) throw new Error('Failed to load comparison');
        const data = await res.json();
        // expected data: {id, name, product_ids: [1,2,3], products: [{...}]}
        // reset UI and fill slots
        document.querySelectorAll('.plusBtn').forEach(el => resetSlotToPlus(el));
        (data.products || []).forEach((p, i)=> fillSlotWithProduct(i, p));
        document.getElementById('detailArea').innerHTML = '';
    }catch(e){
        console.error(e);
        alert('Could not load this comparison.');
    }
}

async function saveCurrentComparison(){
    // collect product ids from UI
    const products = [];
    document.querySelectorAll('.plusBtn').forEach(el => {
        const nameEl = el.querySelector('.font-semibold');
        const brandEl = el.querySelector('.text-xs');
        if(nameEl){
            // try to find product id from cached products by matching name+brand
            const name = nameEl.innerText.trim();
            const brand = brandEl ? brandEl.innerText.trim() : '';
            const found = productsCache.find(p => (p.name === name && p.brand === brand));
            if(found) products.push(found.id);
        }
    });

    if(products.length === 0){
        alert('Please add at least one product to save comparison.');
        return;
    }

    const payload = {
        name: `Comparison - ${new Date().toLocaleString()}`,
        product_ids: products
    };

    try{
        const csrftoken = getCookie('csrftoken');
        const res = await fetch(SAVE_COMPARISON_API, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('Save failed');
        const saved = await res.json();
        alert('Comparison saved');
        loadHistoryList();
    }catch(e){
        console.error(e);
        alert('Failed to save comparison. Make sure your backend endpoint exists.');
    }
}

saveComparisonBtn.addEventListener('click', saveCurrentComparison);

/* -------------------------
   Initial load: histories
   ------------------------- */
loadHistoryList();

/* -------------------------
   Close modal when clicking outside the dialog
   ------------------------- */
searchModal.addEventListener("click", (e)=> {
    if(e.target === searchModal) closeSearchModal();
});
</script>

</body>
</html>
