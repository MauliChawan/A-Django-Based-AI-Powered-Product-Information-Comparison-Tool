<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Comparsy</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>

    <style>
        ::-webkit-scrollbar{
            width: 6px;
        }
        ::-webkit-scrollbar-thumb{
            background: #87CEFA;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

<!-- SIDEBAR -->
<div class="fixed left-0 top-0 h-screen w-64 border-r border-gray-300 px-4 py-6 bg-white">
    <h1 class="font-bold text-xl mb-6 text-black-600"><br>Comparsy</h1>

    <div class="space-y-2 overflow-y-auto h-[80vh]">
        <div id="newChatBtn" class="cursor-pointer hover:bg-gray-200 p-2 rounded bg-blue-50">New Chat</div>
        <div id="historyList" class="mt-4 space-y-2">
            <div class="text-sm text-gray-500 px-2">Loading history...</div>
        </div>
    </div>
</div>

<!-- NAVBAR -->
<div class="fixed left-64 top-0 right-0 h-14 border-b border-gray-300 flex items-center justify-between px-6 bg-white">
    <div class="font-bold text-xl mb-2 text-black-600">Comparsy AI Product Comparison</div>

    <div class="flex items-center gap-5">
        {% if request.user.is_authenticated %}
            <form method="post" action="/logout/">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1 border border-red-500 text-red-600 rounded hover:bg-red-50">Logout</button>
            </form>
        {% else %}
            <a href="/login/" class="px-3 py-1 border border-blue-500 text-blue-600 rounded hover:bg-blue-50">Login</a>
            <a href="/signup/" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Signup</a>
        {% endif %}

        <div class="relative">
            <i id="userBtn" class="fa-regular fa-user text-xl cursor-pointer hover:text-blue-600"></i>

            <div id="userDropdown" class="absolute right-0 mt-2 w-40 bg-white shadow border rounded hidden">
                <div class="px-3 py-2 border-b font-semibold">{{ request.user.username|default:"Guest" }}</div>
                <a class="block px-3 py-2 hover:bg-gray-100 cursor-pointer">Help</a>
                <a class="block px-3 py-2 hover:bg-gray-100 cursor-pointer">About Comparsy</a>
            </div>
        </div>

        <i class="fa-solid fa-share-nodes text-xl cursor-pointer hover:text-blue-600"></i>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="ml-64 mt-20 px-6">

    <!-- AMAZON REAL-TIME SEARCH BAR -->
    <div class="flex justify-center mb-6">
        <div class="w-full max-w-xl relative">
            <input id="searchBox"
                   type="text"
                   placeholder="Search products from Amazon..."
                   class="w-full border p-3 rounded-lg shadow-sm" />

            <!-- Live Results -->
            <div id="searchResults"
                 class="absolute left-0 right-0 top-full bg-white border rounded-lg shadow max-h-80 overflow-y-auto hidden z-40">
            </div>
        </div>
    </div>

    <!-- Comparison Slots (3 blocks) -->
    <div class="flex justify-center gap-6" id="productSlotsContainer">

        <div class="product-block empty w-full max-w-sm h-64 border border-blue-400 rounded-xl flex items-center justify-center bg-white cursor-pointer hover:bg-blue-50">
            <span class="text-8xl font-light text-blue-600">+</span>
        </div>

        <div class="product-block empty w-full max-w-sm h-64 border border-blue-400 rounded-xl flex items-center justify-center bg-white cursor-pointer hover:bg-blue-50">
            <span class="text-8xl font-light text-blue-600">+</span>
        </div>

        <div class="product-block empty w-full max-w-sm h-64 border border-blue-400 rounded-xl flex items-center justify-center bg-white cursor-pointer hover:bg-blue-50">
            <span class="text-8xl font-light text-blue-600">+</span>
        </div>

    </div>

    <div id="detailArea" class="mt-6"></div>
</div>

{% block content %}{% endblock %}

<!-- PRODUCT SEARCH MODAL (OLDER YOU FEATURE – KEPT) -->
<div id="searchModal" class="fixed inset-0 bg-black/40 flex justify-center items-center hidden z-50">
    <div class="bg-white w-96 rounded-xl p-5">
        <h2 class="text-lg font-semibold mb-3">Search product</h2>
        <input id="searchInput" type="text" class="w-full border p-2 rounded mb-2" placeholder="Type product...">
        <div id="suggestions" class="max-h-56 overflow-y-auto mt-2 space-y-1"></div>

        <div class="mt-4 flex gap-3">
            <button id="selectBtn" class="flex-1 w-full bg-blue-600 text-white py-2 rounded">Select</button>
            <button id="closeBtn" class="flex-1 w-full border py-2 rounded">Cancel</button>
        </div>

        <p id="closeModalText" class="mt-3 text-center text-sm text-gray-500 cursor-pointer">Close</p>
    </div>
</div>

<!-- JS SCRIPT SECTION -->
<script>
/* -------------------------
 REAL-TIME AMAZON SEARCH (RapidAPI)
-------------------------- */

const API_KEY = "7c7b9fd903mshe74fd83b4c1458fp159af5jsn249df19931e9";

async function searchAmazonProducts(query) {
    try {
        const response = await fetch(
            `https://real-time-amazon-data.p.rapidapi.com/search?query=${encodeURIComponent(query)}&page=1&country=IN`,
            {
                method: "GET",
                headers: {
                    "x-rapidapi-key": API_KEY,
                    "x-rapidapi-host": "real-time-amazon-data.p.rapidapi.com"
                }
            }
        );

        const data = await response.json();
        return data.data.products || [];
    } catch (err) {
        console.error("API Error:", err);
        return [];
    }
}

const searchBox = document.getElementById("searchBox");
const searchResults = document.getElementById("searchResults");

searchBox.addEventListener("input", async function () {
    const query = this.value.trim();

    if (query.length < 3) {
        searchResults.classList.add("hidden");
        return;
    }

    searchResults.innerHTML = `<p class='p-2 text-gray-500'>Searching...</p>`;
    searchResults.classList.remove("hidden");

    const results = await searchAmazonProducts(query);

    if (results.length === 0) {
        searchResults.innerHTML = `<p class='p-2 text-gray-500'>No products found</p>`;
        return;
    }

    searchResults.innerHTML = "";

    results.forEach((product) => {
        const item = document.createElement("div");
        item.classList = "p-2 hover:bg-gray-100 cursor-pointer border-b";

        item.innerHTML = `
            <div class="flex items-center gap-3">
                <img src="${product.product_photo}" class="w-12 h-12 object-cover rounded" />
                <div>
                    <p class="font-semibold">${product.product_title.substring(0, 60)}...</p>
                    <p class="text-sm text-gray-500">₹${product.product_price}</p>
                </div>
            </div>
        `;

        item.addEventListener("click", () => {
            addProductToCompare(product);
            searchResults.classList.add("hidden");
            searchBox.value = "";
        });

        searchResults.appendChild(item);
    });
});

/* -------------------------
 ADD PRODUCT TO COMPARISON (3 BLOCKS)
-------------------------- */

function addProductToCompare(product) {
    const emptyBlock = document.querySelector(".product-block.empty");

    if (!emptyBlock) {
        alert("You can compare only 3 products");
        return;
    }

    emptyBlock.classList.remove("empty");
    emptyBlock.innerHTML = `
        <div class="flex flex-col items-center">
            <img src="${product.product_photo}" class="w-full h-40 object-cover rounded" />
            <h3 class="font-bold mt-2">${product.product_title.substring(0, 50)}...</h3>
            <p class="text-green-600 font-semibold text-lg mt-1">₹${product.product_price}</p>
        </div>
    `;
}
<script>
async function searchProducts(query, inputBoxId, resultsBoxId) {
    if (!query) {
        document.getElementById(resultsBoxId).innerHTML = "";
        return;
    }

    const response = await fetch(`/search/?query=${query}`);
    const data = await response.json();

    let results = data.data || [];

    let html = "";
    results.slice(0, 5).forEach(item => {
        html += `
            <div onclick="addProduct('${item.product_title}', '${inputBoxId}')"
                class="p-2 hover:bg-gray-100 cursor-pointer border-b">
                ${item.product_title}
            </div>
        `;
    });

    document.getElementById(resultsBoxId).innerHTML = html;
}

function addProduct(name, inputBoxId) {
    document.getElementById(inputBoxId).value = name;
}
</script>

</script>

</body>
</html>
