<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Comparsy</title>

    {% load static %}

    <!-- App Cascading style sheet  -->


    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    


    <!-- Tailwind & icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>

    <style>
        ::-webkit-scrollbar{ width: 6px; }
        ::-webkit-scrollbar-thumb{ background: #87CEFA; border-radius: 4px; }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

<!-- SIDEBAR -->
<div class="fixed left-0 top-0 h-screen w-64 border-r border-gray-300 px-4 py-6 bg-white">
    <h1 class="font-bold text-xl mb-6 text-black-600"><br>Comparsy</h1>

    <div class="space-y-2 overflow-y-auto h-[80vh]">
        <div id="newChatBtn" class="cursor-pointer hover:bg-gray-200 p-2 rounded bg-blue-50">New Chat</div>
        <div id="historyList" class="mt-4 space-y-2">
            <div class="text-sm text-gray-500 px-2">Loading history...</div>
        </div>
    </div>
</div>

<!-- NAVBAR -->
<div class="fixed left-64 top-0 right-0 h-14 border-b border-gray-300 flex items-center justify-between px-6 bg-white">
    <div class="font-bold text-xl mb-2 text-black-600">Comparsy AI Product Comparison</div>

    <div class="flex items-center gap-5">
        {% if request.user.is_authenticated %}
            <form method="post" action="/logout/">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1 border border-red-500 text-red-600 rounded hover:bg-red-50">Logout</button>
            </form>
        {% else %}
            <a href="/login/" class="px-3 py-1 border border-blue-500 text-blue-600 rounded hover:bg-blue-50">Login</a>
            <a href="/signup/" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Signup</a>
        {% endif %}

        <div class="relative">
            <i id="userBtn" class="fa-regular fa-user text-xl cursor-pointer hover:text-blue-600"></i>

            <div id="userDropdown" class="absolute right-0 mt-2 w-44 bg-white shadow border rounded hidden">
                <div class="px-3 py-2 border-b font-semibold">
                    {{ request.user.username|default:"Guest" }}
                </div>
                <a href="#" class="block px-3 py-2 hover:bg-gray-100">Help</a>
                <a href="#" class="block px-3 py-2 hover:bg-gray-100">About Comparsy</a>
            </div>
        </div>

        <i class="fa-solid fa-share-nodes text-xl cursor-pointer hover:text-blue-600"></i>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="ml-64 mt-20 px-6">

    <!-- Controls -->
    <div class="flex items-center justify-end gap-3 mb-4">
        <button id="saveComparisonBtn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Save Comparison</button>
        <button id="exportBtn" class="px-3 py-1 border rounded">Export</button>
    </div>

    <!-- 3 SLOTS -->
    <div id="slots" class="flex justify-center gap-6">
        <div class="slot block-slot w-full max-w-sm h-64 border border-blue-400 rounded-xl flex items-center justify-center bg-white cursor-pointer hover:bg-blue-50"
             data-slot-index="0">
            <span class="text-8xl font-light text-blue-600">+</span>
        </div>

        <div class="slot block-slot w-full max-w-sm h-64 border border-blue-400 rounded-xl flex items-center justify-center bg-white cursor-pointer hover:bg-blue-50"
             data-slot-index="1">
            <span class="text-8xl font-light text-blue-600">+</span>
        </div>

        <div class="slot block-slot w-full max-w-sm h-64 border border-blue-400 rounded-xl flex items-center justify-center bg-white cursor-pointer hover:bg-blue-50"
             data-slot-index="2">
            <span class="text-8xl font-light text-blue-600">+</span>
        </div>
    </div>

    <!-- Comparison Table Area -->
    <div id="comparisonArea" class="mt-8"></div>
</div>

{% block content %}{% endblock %}

<!-- SEARCH MODAL (opens when user clicks a '+') -->
<div id="searchModal" class="fixed inset-0 bg-black/40 flex justify-center items-start pt-28 hidden z-50" aria-hidden="true">
    <div class="bg-white w-11/12 max-w-xl rounded-xl p-5 shadow-lg">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Search product</h2>
            <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>

        <input id="modalSearchInput" type="text" placeholder="Type product name (e.g. iPhone 15 Pro)"
               class="w-full border p-3 rounded mb-3 focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="off" />

        <div id="modalSuggestions" class="max-h-72 overflow-y-auto space-y-1"></div>

        <div class="mt-4 flex justify-end gap-3">
            <button id="modalCancelBtn" class="px-4 py-2 border rounded">Cancel</button>
        </div>
    </div>
</div>

<!-- Include your static JS files (deferred) -->
<script src="{% static 'js/search.js' %}" defer></script>
<script src="{% static 'js/history.js' %}" defer></script>

<!-- Inline fallback/robust script for modal behaviour + comparison rendering.
     Keep this short — main search logic should live in search.js, but we
     include robust glue in case of API shape differences. -->
<script>
/* -------------------------
   App state
--------------------------*/
let openSlotIndex = null;            // which slot opened modal
const productsInSlots = [null, null, null];  // store detailed product objects

/* -------------------------
   Helpers
--------------------------*/
function el(id){ return document.getElementById(id); }

function formatPriceForDisplay(raw){
    if(raw === null || raw === undefined || raw === "") return "NA";
    try { return String(raw); } catch(e) { return "NA"; }
}

/* -------------------------
   Profile dropdown
--------------------------*/
const userBtn = el("userBtn");
const userDropdown = el("userDropdown");
if(userBtn){
    userBtn.addEventListener("click", ()=> userDropdown.classList.toggle("hidden"));
    document.addEventListener("click", (e)=> {
        if(!e.target.closest("#userBtn") && !e.target.closest("#userDropdown")) {
            userDropdown.classList.add("hidden");
        }
    });
}

/* -------------------------
   Modal open / close
--------------------------*/
const searchModal = el("searchModal");
const modalSearchInput = el("modalSearchInput");
const modalSuggestions = el("modalSuggestions");
const closeModalBtn = el("closeModalBtn");
const modalCancelBtn = el("modalCancelBtn");

// open modal when clicking a slot
document.querySelectorAll(".block-slot").forEach(slot => {
    slot.addEventListener("click", (e)=> {
        openSlotIndex = Number(slot.getAttribute("data-slot-index"));
        openSearchModal();
    });
});

function openSearchModal(){
    if(modalSearchInput) modalSearchInput.value = "";
    if(modalSuggestions) modalSuggestions.innerHTML = `<div class="p-3 text-sm text-gray-500">Type 3+ characters to search</div>`;
    if(searchModal) searchModal.classList.remove("hidden");
    setTimeout(()=> modalSearchInput && modalSearchInput.focus(), 100);
}

function closeSearchModal(){
    if(searchModal) searchModal.classList.add("hidden");
    if(modalSearchInput) modalSearchInput.value = "";
    if(modalSuggestions) modalSuggestions.innerHTML = "";
    openSlotIndex = null;
}

closeModalBtn && closeModalBtn.addEventListener("click", closeSearchModal);
modalCancelBtn && modalCancelBtn.addEventListener("click", closeSearchModal);
searchModal && searchModal.addEventListener("click", (e)=> { if(e.target === searchModal) closeSearchModal(); });

/* -------------------------
   Debounced backend search (robust to many API shapes)
   Endpoint: /api/search/?query=...
--------------------------*/
let searchDebounceTimer = null;
modalSearchInput && modalSearchInput.addEventListener("input", ()=> {
    const q = modalSearchInput.value.trim();
    modalSuggestions.innerHTML = "";
    if(q.length < 3) {
        modalSuggestions.innerHTML = `<div class="p-3 text-sm text-gray-500">Type 3+ characters to search</div>`;
        return;
    }

    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(()=> performBackendSearch(q), 350);
});

async function performBackendSearch(query){
    if(!modalSuggestions) return;
    modalSuggestions.innerHTML = `<div class="p-3 text-sm text-gray-500">Searching...</div>`;

    try{
        const resp = await fetch(`/api/search/?query=${encodeURIComponent(query)}`);
        if(!resp.ok){
            throw new Error(`Search endpoint returned ${resp.status}`);
        }
        const data = await resp.json();

        // Accept many shapes: { results: [...] } OR { products: [...] } OR { data: { products: [...] } } OR raw array
        let candidates = [];
        if(data) {
            if (Array.isArray(data.results)) candidates = data.results;
            else if (Array.isArray(data.products)) candidates = data.products;
            else if (data && data.data && Array.isArray(data.data.products)) candidates = data.data.products;
            else if (Array.isArray(data)) candidates = data;
        }

        // normalize to objects expected by renderModalSuggestions
        const normalized = candidates.map(item => {
            if (!item || typeof item === 'string') return null;
            // common fields
            return {
                asin: item.asin || item.ASIN || item.id || item.item_id || "",
                title: item.product_title || item.title || item.name || "",
                price: item.product_price || item.price || item.product_minimum_offer_price || "",
                image: item.product_photo || item.image || item.thumbnail || "",
                rating: item.product_star_rating || item.rating || item.stars || "",
                total_ratings: item.product_num_ratings || item.total_ratings || item.reviews || 0,
                url: item.product_url || item.url || ""
            };
        }).filter(Boolean);

        renderModalSuggestions(normalized);
    }catch(err){
        console.error(err);
        modalSuggestions.innerHTML = `<div class="p-3 text-sm text-red-500">Search failed — try again</div>`;
    }
}

function renderModalSuggestions(list){
    if(!modalSuggestions) return;
    if(!list || list.length === 0){
        modalSuggestions.innerHTML = `<div class="p-3 text-sm text-gray-500">No results</div>`;
        return;
    }

    modalSuggestions.innerHTML = "";
    list.slice(0, 12).forEach(item => {
        const asin = item.asin || "";
        const title = (item.title || "").toString();
        const price = item.price || "";
        const photo = item.image || "";

        const node = document.createElement("div");
        node.className = "p-2 hover:bg-gray-100 cursor-pointer border-b flex items-center gap-3";
        node.innerHTML = `
            <img src="${photo || ''}" class="w-12 h-12 object-cover rounded" onerror="this.style.visibility='hidden'" />
            <div class="flex-1">
                <div class="font-semibold text-sm">${escapeHtml(title.substring(0, 90))}</div>
                <div class="text-xs text-gray-500">${formatPriceForDisplay(price)}</div>
            </div>
            <div class="text-xs text-gray-600">${escapeHtml(asin)}</div>
        `;

        node.addEventListener("click", ()=> {
            // when user picks an item, fetch full details by asin (or url)
            if(asin){
                fetchProductDetailsByASIN(asin);
            } else {
                const url = item.url || "";
                if(url) fetchProductDetailsByUrl(url);
                else alert("Cannot fetch details for this item");
            }
            closeSearchModal();
        });

        modalSuggestions.appendChild(node);
    });
}

/* -------------------------
   Fetch product details (proxy via Django)
   Endpoint: /api/product-details/?asin=...  or /api/product-details/?url=...
--------------------------*/
async function fetchProductDetailsByASIN(asin){
    try{
        showSlotLoading(openSlotIndex);
        const res = await fetch(`/api/product-details/?asin=${encodeURIComponent(asin)}`);
        if(!res.ok) throw new Error(`Details endpoint returned ${res.status}`);
        const data = await res.json();

        // extract product object from different shapes
        let productObj = null;
        if(data && data.data && data.data.product) productObj = data.data.product;
        else if(data && data.data && Array.isArray(data.data.products) && data.data.products.length) productObj = data.data.products[0];
        else if(data && data.product) productObj = data.product;
        else if(data && Array.isArray(data) && data.length) productObj = data[0];
        else if (data && typeof data === 'object' && (data.title || data.asin || data.image)) productObj = data;
        else productObj = null;

        const normalized = normalizeProduct(productObj);
        placeProductInSlot(openSlotIndex, normalized);
    }catch(err){
        console.error(err);
        clearSlotLoading(openSlotIndex);
        alert("Failed to load product details.");
    }
}

async function fetchProductDetailsByUrl(url){
    try{
        showSlotLoading(openSlotIndex);
        const res = await fetch(`/api/product-details/?url=${encodeURIComponent(url)}`);
        if(!res.ok) throw new Error(`Details endpoint returned ${res.status}`);
        const data = await res.json();

        let productObj = null;
        if(data && data.data && data.data.product) productObj = data.data.product;
        else if(data && data.product) productObj = data.product;
        else if(data && typeof data === 'object' && (data.title || data.asin || data.image)) productObj = data;
        else productObj = null;

        const normalized = normalizeProduct(productObj);
        placeProductInSlot(openSlotIndex, normalized);
    }catch(err){
        console.error(err);
        clearSlotLoading(openSlotIndex);
        alert("Failed to load product details.");
    }
}

/* -------------------------
   Normalization helper for detailed product
--------------------------*/
function normalizeProduct(p){
    if(!p || typeof p !== 'object') return null;

    const asin = p.asin || p.ASIN || p.id || p.product_id || "";
    const title = p.product_title || p.title || p.name || "";
    const price = p.product_price || p.price || p.product_minimum_offer_price || p.product_original_price || "";
    const original_price = p.product_original_price || p.original_price || "";
    const image = p.product_photo || p.image || p.thumbnail || (Array.isArray(p.images) ? p.images[0] : "") || "";
    const url = p.product_url || p.url || p.link || "";

    // create specs object (if present)
    let specs = {};
    if(p.specs && typeof p.specs === "object") specs = {...specs, ...p.specs};
    if(p.specifications && typeof p.specifications === "object" && !Array.isArray(p.specifications)) specs = {...specs, ...p.specifications};
    if(Array.isArray(p.specifications)){
        p.specifications.forEach(it => {
            if(it && typeof it === 'object'){
                if(it.key && it.value) specs[it.key] = it.value;
                else if(it.name && it.value) specs[it.name] = it.value;
            }
        });
    }
    if(Array.isArray(p.attributes)){
        p.attributes.forEach(a => {
            if(a && a.name) specs[a.name] = a.value || a.value_text || "";
        });
    }
    if(Array.isArray(p.key_features)) specs["Key Features"] = p.key_features.join(" | ");
    if(Array.isArray(p.features)) specs["Features"] = p.features.join(" | ");

    if(p.brand && !specs["Brand"]) specs["Brand"] = p.brand;
    if(p.model && !specs["Model"]) specs["Model"] = p.model;
    if(title && !specs["Title"]) specs["Title"] = title;
    if(price && !specs["Price"]) specs["Price"] = price;

    return { asin, title, price, original_price, image, url, raw: p, specs };
}

/* -------------------------
   UI: slot helpers + place product
--------------------------*/
function showSlotLoading(idx){
    const slot = document.querySelector(`.block-slot[data-slot-index="${idx}"]`);
    if(slot) slot.innerHTML = `<div class="text-sm text-gray-500">Loading...</div>`;
}

function clearSlotLoading(idx){
    const slot = document.querySelector(`.block-slot[data-slot-index="${idx}"]`);
    if(slot) slot.innerHTML = `<span class="text-8xl font-light text-blue-600">+</span>`;
}

function placeProductInSlot(idx, product){
    if(idx === null || idx === undefined) return;
    const slot = document.querySelector(`.block-slot[data-slot-index="${idx}"]`);
    if(!slot){
        alert("Slot not found");
        return;
    }
    if(!product){
        clearSlotLoading(idx);
        alert("Invalid product data");
        return;
    }

    productsInSlots[idx] = product;

    slot.innerHTML = `
        <div class="w-full h-full p-3 flex flex-col justify-between">
            <div>
                <img src="${product.image || ''}" class="w-full h-36 object-contain rounded mb-2 bg-white" onerror="this.style.visibility='hidden'"/>
                <div class="font-semibold text-sm line-clamp-2">${escapeHtml(product.title || "")}</div>
            </div>
            <div class="flex items-center justify-between mt-2">
                <div class="text-green-600 font-semibold">${formatPriceForDisplay(product.price)}</div>
                <div class="flex gap-2">
                    <button class="remove-btn px-2 py-1 border rounded text-sm">Remove</button>
                    <button class="view-btn px-2 py-1 border rounded text-sm">View</button>
                </div>
            </div>
        </div>
    `;

    const removeBtn = slot.querySelector(".remove-btn");
    removeBtn.addEventListener("click", ()=> {
        productsInSlots[idx] = null;
        slot.innerHTML = `<span class="text-8xl font-light text-blue-600">+</span>`;
        renderComparisonTable();
    });

    const viewBtn = slot.querySelector(".view-btn");
    viewBtn.addEventListener("click", ()=> {
        showProductDetailsModal(product);
    });

    renderComparisonTable();
}

/* -------------------------
   Product details modal
--------------------------*/
function showProductDetailsModal(product){
    const overlay = document.createElement("div");
    overlay.className = "fixed inset-0 bg-black/40 flex justify-center items-start pt-24 z-60";
    overlay.innerHTML = `
        <div class="bg-white w-11/12 max-w-2xl rounded-xl p-5 shadow-lg">
            <div class="flex justify-between items-start gap-4">
                <div class="w-1/3">
                    <img src="${product.image || ''}" class="w-full h-48 object-contain" onerror="this.style.visibility='hidden'"/>
                </div>
                <div class="w-2/3">
                    <h3 class="text-lg font-semibold mb-2">${escapeHtml(product.title || "")}</h3>
                    <div class="text-green-600 font-semibold mb-3">${formatPriceForDisplay(product.price)}</div>
                    <div id="detailSpecs" class="text-sm text-gray-700 max-h-64 overflow-y-auto"></div>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button id="closeDetailBtn" class="px-3 py-1 border rounded">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    const detailSpecs = overlay.querySelector("#detailSpecs");
    detailSpecs.innerHTML = buildSpecsHTML(product.specs || {});

    overlay.querySelector("#closeDetailBtn").addEventListener("click", ()=> overlay.remove());
    overlay.addEventListener("click", (e)=> { if(e.target === overlay) overlay.remove(); });
}

function buildSpecsHTML(specsObj){
    if(!specsObj || Object.keys(specsObj).length===0) return "<div class='text-sm text-gray-500'>No specs available</div>";
    let html = "<table class='w-full text-sm'>";
    for(const [k,v] of Object.entries(specsObj)){
        html += `<tr class="border-b"><td class="py-2 font-medium w-1/3">${escapeHtml(k)}</td><td class="py-2">${escapeHtml(String(v ?? ""))}</td></tr>`;
    }
    html += "</table>";
    return html;
}

function escapeHtml(str){
    return (str || "").replaceAll("&", "&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* -------------------------
   Render comparison table
--------------------------*/
function renderComparisonTable(){
    const area = el("comparisonArea");
    const items = productsInSlots.filter(Boolean);
    if(!area) return;

    if(items.length === 0){
        area.innerHTML = `<div class="text-center text-gray-500">Add 1-3 products by clicking + to compare</div>`;
        return;
    }

    const allKeys = new Set();
    items.forEach(p => {
        if(p.specs && typeof p.specs === "object"){
            Object.keys(p.specs).forEach(k=> allKeys.add(k));
        }
        if(p.title) allKeys.add("Title");
        if(p.price) allKeys.add("Price");
    });

    const keys = Array.from(allKeys);
    let html = `<div class="overflow-auto"><table class="w-full border-collapse">`;
    html += `<thead><tr class="bg-gray-100 text-left"><th class="p-3 w-48">Spec</th>`;
    items.forEach((p,i)=> {
        html += `<th class="p-3 border-l">${escapeHtml(p.title || "Product "+(i+1))}</th>`;
    });
    html += `</tr></thead><tbody>`;

    keys.forEach(key => {
        html += `<tr class="border-t align-top"><td class="p-3 font-medium w-48 bg-white">${escapeHtml(key)}</td>`;
        items.forEach(p => {
            let v = "NA";
            if(p.specs && (key in p.specs)) v = p.specs[key];
            else if(key === "Title") v = p.title;
            else if(key === "Price") v = p.price;
            html += `<td class="p-3 border-l align-top">${escapeHtml(String(v ?? "NA"))}</td>`;
        });
        html += `</tr>`;
    });

    html += `</tbody></table></div>`;
    area.innerHTML = html;
}

/* -------------------------
   Initial render
--------------------------*/
renderComparisonTable();

/* -------------------------
   Accessibility: Enter picks first suggestion
--------------------------*/
modalSearchInput && modalSearchInput.addEventListener("keydown", (e)=> {
    if(e.key === "Enter"){
        e.preventDefault();
        const first = modalSuggestions && modalSuggestions.querySelector(".cursor-pointer");
        if(first) first.click();
        else {
            // If no clickable suggestion, try performing the search via API (in case user wants to hit enter)
            const q = modalSearchInput.value.trim();
            if(q.length >= 3) performBackendSearch(q);
        }
    }
});
</script>

</body>
</html>
